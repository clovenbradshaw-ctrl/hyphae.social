<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyphae Network - Join the Emergent Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1d29;
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* Setup Mode Indicator */
        .mode-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(180, 165, 216, 0.1);
            border: 2px solid rgba(180, 165, 216, 0.3);
            border-radius: 12px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #b4a5d8;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
        }

        .mode-indicator:hover {
            background: rgba(180, 165, 216, 0.2);
            border-color: #b4a5d8;
        }

        .mode-indicator.visible {
            display: block;
        }

        body.assisted-mode-active .mode-indicator {
            top: 90px;
            right: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 640px) {
            body.assisted-mode-active .mode-indicator {
                top: auto;
                right: auto;
                left: 20px;
                bottom: 90px;
            }
        }

        @media (max-width: 640px) {
            .mode-indicator {
                top: auto;
                right: auto;
                left: 20px;
                bottom: 20px;
                font-size: 11px;
                padding: 6px 14px;
            }
        }

        /* View Management */
        .view {
            display: none;
            animation: fadeIn 0.5s ease-out;
            min-height: 100vh;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== MODE SELECTION VIEW ===== */
        .mode-selection-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
            text-align: center;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
        }

        .mode-selection-container h1 {
            color: #b4a5d8;
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 15px;
            letter-spacing: 4px;
        }

        .mode-subtitle {
            color: #8a8a9e;
            font-size: 18px;
            margin-bottom: 60px;
            line-height: 1.6;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .mode-card {
            background: #252836;
            border: 3px solid #353849;
            border-radius: 20px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card:hover {
            border-color: #b4a5d8;
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(180, 165, 216, 0.3);
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #b4a5d8, transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .mode-card:hover::before {
            transform: translateX(100%);
        }

        .mode-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .mode-title {
            font-size: 24px;
            color: #b4a5d8;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .mode-description {
            font-size: 14px;
            color: #8a8a9e;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .mode-features {
            text-align: left;
            font-size: 13px;
            color: #d4d4d8;
        }

        .mode-features li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .mode-features li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #10b981;
        }

        .mode-recommendation {
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== ASSISTED MODE PROGRESS BAR ===== */
        .assisted-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(37, 40, 54, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #353849;
            padding: 20px;
            z-index: 100;
            display: none;
        }

        .assisted-progress.visible {
            display: block;
        }

        .progress-steps {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .progress-step::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #353849;
        }

        .progress-step.completed::after {
            background: linear-gradient(90deg, #10b981 0%, #10b981 50%, #353849 50%);
        }

        .progress-step:last-child::after {
            display: none;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            background: #353849;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background: #b4a5d8;
            color: #1a1d29;
            box-shadow: 0 0 20px rgba(180, 165, 216, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .step-circle.completed {
            background: #10b981;
            color: #1a1d29;
        }

        .step-label {
            font-size: 11px;
            color: #8a8a9e;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== LANDING/REGISTRATION VIEWS ===== */
        .landing-container, .register-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .register-container.assisted-mode {
            padding-top: 100px; /* Space for progress bar */
        }

        /* Header with back button */
        .header-nav {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #8a8a9e;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            cursor: pointer;
        }

        .back-link:hover {
            color: #b4a5d8;
        }

        h1, h2 {
            color: #b4a5d8;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #8a8a9e;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 30px;
        }

        /* Section styling */
        .section {
            margin-bottom: 35px;
            position: relative;
        }

        .section.highlight {
            background: rgba(180, 165, 216, 0.05);
            border: 2px solid rgba(180, 165, 216, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #b4a5d8;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Username selection */
        .username-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .username-card {
            background: #252836;
            border: 2px solid #353849;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .username-card:hover {
            border-color: #b4a5d8;
            transform: translateY(-2px);
            background: #2a2d3e;
        }

        .username-card.selected {
            border-color: #b4a5d8;
            background: rgba(180, 165, 216, 0.1);
        }

        .username-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #b4a5d8;
            font-size: 18px;
            font-weight: bold;
        }

        .username-text {
            font-size: 16px;
            font-weight: 500;
            color: #e0e0e0;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .username-hint {
            font-size: 11px;
            color: #8a8a9e;
        }

        /* Buttons */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-primary {
            background: #b4a5d8;
            color: #1a1d29;
            box-shadow: 0 10px 40px rgba(180, 165, 216, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: #c4b5e8;
            transform: translateY(-3px);
            box-shadow: 0 15px 50px rgba(180, 165, 216, 0.4);
        }

        .btn-secondary {
            background: rgba(180, 165, 216, 0.1);
            border: 2px solid rgba(180, 165, 216, 0.3);
            color: #b4a5d8;
        }

        .btn-secondary:hover {
            background: rgba(180, 165, 216, 0.2);
            border-color: #b4a5d8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .regenerate-btn {
            width: 100%;
            padding: 12px;
            background: rgba(180, 165, 216, 0.1);
            border: 2px solid rgba(180, 165, 216, 0.3);
            border-radius: 10px;
            color: #b4a5d8;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .regenerate-btn:hover {
            background: rgba(180, 165, 216, 0.2);
            border-color: #b4a5d8;
        }

        /* Password display */
        .password-display {
            background: #252836;
            border: 2px solid #353849;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .password-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .password-text {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #e0e0e0;
            flex-grow: 1;
            letter-spacing: 2px;
        }

        .copy-btn {
            padding: 8px 16px;
            background: rgba(180, 165, 216, 0.2);
            border: none;
            border-radius: 6px;
            color: #b4a5d8;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(180, 165, 216, 0.3);
        }

        .copy-btn.copied {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        /* Input fields */
        .manual-input {
            width: 100%;
            padding: 15px;
            background: #1a1d29;
            border: 2px solid #353849;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .manual-input:focus {
            outline: none;
            border-color: #b4a5d8;
            background: #1f2230;
        }

        /* Info cards */
        .info-card {
            background: rgba(180, 165, 216, 0.05);
            border: 2px solid rgba(180, 165, 216, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-card.warning {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .info-card.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .info-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #b4a5d8;
        }

        .info-content {
            font-size: 13px;
            line-height: 1.6;
            color: #d4d4d8;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .action-buttons.assisted {
            justify-content: space-between;
            padding-top: 20px;
            border-top: 1px solid #353849;
        }

        /* Success View */
        .success-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 60px 20px;
            text-align: center;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
        }

        .setup-step {
            text-align: left;
            margin-top: 30px;
        }

        .setup-step h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .credentials-box {
            background: #252836;
            border: 2px solid #b4a5d8;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .mobile-credential-actions {
            display: none;
            margin-top: -10px;
            margin-bottom: 20px;
            background: rgba(180, 165, 216, 0.1);
            border: 1px solid rgba(180, 165, 216, 0.2);
            border-radius: 12px;
            padding: 16px;
        }

        .mobile-credential-actions p {
            font-size: 13px;
            color: #d4d4d8;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .credential-item {
            margin-bottom: 20px;
        }

        .credential-label {
            font-size: 12px;
            color: #8a8a9e;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .credential-value-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1d29;
            border: 2px solid #353849;
            border-radius: 8px;
            padding: 12px 15px;
        }

        .credential-value {
            flex-grow: 1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #e0e0e0;
            letter-spacing: 1px;
            word-break: break-all;
        }

        /* Message Box */
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 2000;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .message.info {
            background: rgba(180, 165, 216, 0.2);
            border: 2px solid rgba(180, 165, 216, 0.6);
            color: #b4a5d8;
        }

        .login-method-cards .method-card {
            order: 0;
        }

        .login-method-cards .method-card.mobile-priority {
            order: -1;
        }

        .login-method-cards .method-card.mobile-highlight {
            border-color: #b4a5d8 !important;
            box-shadow: 0 0 0 2px rgba(180, 165, 216, 0.3);
            background: rgba(180, 165, 216, 0.12) !important;
        }

        /* Mode toggle */
        .mode-toggle-btn {
            flex: 1;
            padding: 10px 20px;
            background: transparent;
            border: 2px solid rgba(180, 165, 216, 0.3);
            border-radius: 8px;
            color: #8a8a9e;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-toggle-btn:hover {
            border-color: rgba(180, 165, 216, 0.5);
            color: #b4a5d8;
        }

        .mode-toggle-btn.active {
            background: rgba(180, 165, 216, 0.2);
            border-color: #b4a5d8;
            color: #b4a5d8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mode-cards {
                grid-template-columns: 1fr;
            }
            
            .username-grid {
                grid-template-columns: 1fr;
            }

            .progress-step .step-label {
                display: none;
            }

        }
    </style>
</head>
<body>
    <!-- Message Box -->
    <div id="messageBox" class="message"></div>

    <!-- Mode Indicator -->
    <div id="modeIndicator" class="mode-indicator" onclick="showModeSelection()">
        <span id="modeIndicatorText">Standard Setup</span> ‚Ä¢ Switch Mode
    </div>

    <!-- Assisted Mode Progress Bar -->
    <div id="assistedProgress" class="assisted-progress">
        <div class="progress-steps">
            <div class="progress-step">
                <div class="step-circle active" id="progress1">1</div>
                <div class="step-label">Username</div>
            </div>
            <div class="progress-step">
                <div class="step-circle" id="progress2">2</div>
                <div class="step-label">Password</div>
            </div>
            <div class="progress-step">
                <div class="step-circle" id="progress3">3</div>
                <div class="step-label">Review</div>
            </div>
            <div class="progress-step">
                <div class="step-circle" id="progress4">‚úì</div>
                <div class="step-label">Complete</div>
            </div>
        </div>
    </div>

    <!-- Mode Selection View -->
    <div id="modeSelectionView" class="view active">
        <div class="mode-selection-container">
            <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="40" fill="none" stroke="#b4a5d8" stroke-width="3"/>
                <path d="M 100 60 Q 80 80 60 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                <path d="M 100 60 Q 120 80 140 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                <path d="M 100 140 Q 80 120 60 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                <path d="M 100 140 Q 120 120 140 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                <path d="M 60 100 Q 40 100 20 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                <path d="M 140 100 Q 160 100 180 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                <circle cx="60" cy="100" r="8" fill="#b4a5d8"/>
                <circle cx="140" cy="100" r="8" fill="#b4a5d8"/>
                <circle cx="20" cy="100" r="6" fill="#b4a5d8"/>
                <circle cx="180" cy="100" r="6" fill="#b4a5d8"/>
            </svg>

            <h1>HYPHAE NETWORK</h1>
            <p class="mode-subtitle">
                Join the emergent network. Choose your preferred setup experience.
            </p>

            <div class="mode-cards">
                <div class="mode-card" onclick="startStandardSetup()">
                    <div class="mode-icon">üöÄ</div>
                    <div class="mode-title">Standard Setup</div>
                    <div class="mode-description">
                        Quick and straightforward account creation for those familiar with Matrix or who prefer independence.
                    </div>
                    <ul class="mode-features">
                        <li>Direct account creation</li>
                        <li>All options on one page</li>
                        <li>Minimal guidance</li>
                        <li>1-2 minutes to complete</li>
                    </ul>
                </div>

                <div class="mode-card" onclick="startAssistedSetup()">
                    <div class="mode-icon">üå±</div>
                    <div class="mode-title">Assisted Setup</div>
                    <div class="mode-description">
                        Step-by-step guided experience with helpful tips and validation at each stage.
                    </div>
                    <ul class="mode-features">
                        <li>Progress tracking</li>
                        <li>Contextual help & tips</li>
                        <li>Input validation</li>
                        <li>2-3 minutes to complete</li>
                    </ul>
                    <div class="mode-recommendation">Recommended for New Users</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <p style="color: #8a8a9e; font-size: 14px;">
                    Already have an account? 
                    <a href="https://hyphae.social/element/#/login" style="color: #b4a5d8; text-decoration: none;">
                        Sign in here ‚Üí
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Registration View (Standard & Assisted) -->
    <div id="registrationView" class="view">
        <div class="register-container" id="registerContainer">
            <div class="header-nav">
                <span class="back-link" onclick="showModeSelection()">
                    ‚Üê Choose Different Mode
                </span>
            </div>

            <div style="text-align: center; margin-bottom: 40px;">
                <svg class="logo" style="width: 80px; height: 80px;" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="100" r="40" fill="none" stroke="#b4a5d8" stroke-width="3"/>
                    <path d="M 100 60 Q 80 80 60 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                    <path d="M 100 60 Q 120 80 140 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                    <path d="M 100 140 Q 80 120 60 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                    <path d="M 100 140 Q 120 120 140 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                    <path d="M 60 100 Q 40 100 20 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                    <path d="M 140 100 Q 160 100 180 100" stroke="#b4a5d8" stroke-width="2" fill="none"/>
                    <circle cx="60" cy="100" r="8" fill="#b4a5d8"/>
                    <circle cx="140" cy="100" r="8" fill="#b4a5d8"/>
                    <circle cx="20" cy="100" r="6" fill="#b4a5d8"/>
                    <circle cx="180" cy="100" r="6" fill="#b4a5d8"/>
                </svg>
                <h2>Join the Network</h2>
                <div class="subtitle">Emergence begins with connection</div>
            </div>

            <!-- Step 1: Username -->
            <div class="section" id="usernameSection">
                <div class="section-title">
                    üåø Choose Your Username
                </div>
                <div class="username-grid" id="usernameGrid"></div>
                <button class="regenerate-btn" onclick="generateUsernames()">
                    üîÑ Generate New Options
                </button>
            </div>

            <!-- Step 2: Password -->
            <div class="section" id="passwordSection")>
                <div class="section-title">
                    üîê Create Password
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="mode-toggle-btn active" id="manualPasswordBtn" onclick="setPasswordMode('manual')">
                        ‚úèÔ∏è Create My Own
                    </button>
                    <button class="mode-toggle-btn" id="autoPasswordBtn" onclick="setPasswordMode('auto')">
                        ‚ú® Auto-Generate
                    </button>
                </div>

                <!-- Manual password -->
                <div id="manualPasswordSection">
                    <input 
                        type="password" 
                        id="manualPassword" 
                        class="manual-input" 
                        placeholder="Enter a strong password"
                        oninput="handleManualPassword()"
                    />
                    <div id="strengthIndicator" style="margin-top: 10px;"></div>
                </div>

                <!-- Auto password -->
                <div id="autoPasswordSection" style="display: none;">
                    <div class="password-display">
                        <div class="password-row">
                            <div class="password-text" id="passwordText">Click generate below</div>
                            <button class="copy-btn" id="copyBtn" onclick="copyPassword()" style="display: none;">Copy</button>
                        </div>
                    </div>
                    <button class="regenerate-btn" onclick="generatePassword()">
                        üîÑ Generate New Password
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="actionButtons">
                <button class="btn btn-primary" id="createAccountBtn" onclick="createAccount()" disabled style="width: 100%;">
                    üöÄ Create Account
                </button>
            </div>
        </div>
    </div>

    <!-- Success View -->
    <div id="successView" class="view">
        <div class="success-container">
            <div class="success-icon">‚úì</div>
            <h2 style="color: #b4a5d8; font-size: 36px; margin-bottom: 15px;">Account Created!</h2>
            <p style="color: #8a8a9e; margin-bottom: 30px;">
                Welcome to the Hyphae Network, <strong id="successUsernameDisplay"></strong>
            </p>

            <!-- Step 1: Save Credentials -->
            <div class="setup-step" id="saveCredentialsStep">
                <h3 style="color: #b4a5d8; font-size: 18px; margin-bottom: 20px;">
                    Step 1: Save Your Credentials
                </h3>

                <div class="credentials-box">
                    <div class="credential-item">
                        <div class="credential-label">Username</div>
                        <div class="credential-value-row">
                            <div class="credential-value" id="finalUsername"></div>
                            <button class="copy-btn" onclick="copyFinalCredential('username')">Copy</button>
                        </div>
                    </div>
                    <div class="credential-item">
                        <div class="credential-label">Password</div>
                        <div class="credential-value-row">
                            <div class="credential-value" id="finalPassword">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                            <button class="copy-btn" onclick="togglePasswordView()">Show</button>
                            <button class="copy-btn" onclick="copyFinalCredential('password')">Copy</button>
                        </div>
                    </div>
                    <div class="credential-item">
                        <div class="credential-label">Server</div>
                        <div class="credential-value-row">
                            <div class="credential-value">hyphae.social</div>
                            <button class="copy-btn" onclick="copyFinalCredential('server')">Copy</button>
                        </div>
                    </div>
                </div>

                <div id="mobileCredentialActions" class="mobile-credential-actions">
                    <p>
                        Need to hop into Element X? Open your credentials in a new tab so you can easily return here to copy and paste them.
                    </p>
                    <button class="btn btn-secondary" onclick="openCredentialsWindow(true)" style="width: 100%;">
                        Open Credentials in New Tab
                    </button>
                </div>

                <div class="info-card warning">
                    <div class="info-title">‚ö†Ô∏è Save These Now</div>
                    <div class="info-content" id="credentialReminder">
                        Copy your credentials to a password manager before continuing.
                    </div>
                </div>

                <button class="btn btn-primary" id="proceedToLoginBtn" onclick="proceedToLogin()" style="width: 100%; margin-top: 20px;">
                    I've Saved My Credentials ‚Üí
                </button>
            </div>

            <!-- Step 2: Login Instructions -->
            <div class="setup-step" id="loginInstructionsStep" style="display: none;">
                <h3 id="loginInstructionsHeading" style="color: #b4a5d8; font-size: 18px; margin-bottom: 20px;">
                    Step 2: Login to Your Account
                </h3>

                <div class="login-method-cards" id="loginMethodCards" style="display: grid; gap: 15px; margin-bottom: 20px;">
                    <div class="method-card" id="webInstructionsCard" style="background: #252836; border: 2px solid #b4a5d8; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #b4a5d8; margin-bottom: 10px;">üåê Web Browser (Recommended)</h4>
                        <ol style="margin: 10px 0 15px 20px; font-size: 14px; line-height: 1.8; color: #d4d4d8;">
                            <li>Click "Open Element Web" below</li>
                            <li>Enter <code style="background: #1a1d29; padding: 2px 6px; border-radius: 4px; color: #b4a5d8;">hyphae.social</code> as the server</li>
                            <li>Paste your username and password</li>
                            <li>Click "Sign In"</li>
                        </ol>
                        <button class="btn btn-primary" onclick="openElementWeb()" style="width: 100%;">
                            Open Element Web ‚Üí
                        </button>
                    </div>

                    <div class="method-card" id="mobileInstructionsCard" style="background: #252836; border: 2px solid #353849; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #b4a5d8; margin-bottom: 10px;">üì± Mobile Setup</h4>
                        <p style="font-size: 14px; line-height: 1.6; margin-bottom: 15px; color: #8a8a9e;">
                            For mobile, download Element X and enter your credentials manually. Deep links from the browser often fail, so open the app yourself and follow the steps below. The QR code beneath is for sharing your profile with others.
                        </p>

                        <div style="background: rgba(180, 165, 216, 0.1); border: 2px solid rgba(180, 165, 216, 0.2); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                            <h5 style="color: #b4a5d8; margin-bottom: 10px; font-size: 14px;">üìã Manual Login Steps:</h5>
                            <ol style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #d4d4d8;">
                                <li>Download Element X from app store</li>
                                <li>Tap "I already have an account"</li>
                                <li>Enter server: <code style="background: #1a1d29; padding: 2px 6px; border-radius: 4px; color: #b4a5d8;">hyphae.social</code></li>
                                <li>Enter your username and password</li>
                                <li>Tap "Sign in"</li>
                            </ol>
                        </div>
                        
                        <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <div id="qrCodeContainer" style="display: flex; justify-content: center;">
                                <!-- QR code will be generated here -->
                            </div>
                            <div style="text-align: center; margin-top: 15px;">
                                <p style="font-size: 11px; color: #333; margin-bottom: 10px;">
                                    <strong>Profile QR Code</strong><br>
                                    Share this to let others add you
                                </p>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="btn btn-secondary" onclick="downloadQR()" style="font-size: 12px; padding: 8px 16px;">
                                        üì• Save QR
                                    </button>
                                    <button class="btn btn-secondary" onclick="shareProfile()" style="font-size: 12px; padding: 8px 16px;">
                                        üì§ Share Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <a href="https://apps.apple.com/app/element-x-secure-messenger/id1631335820" class="btn btn-secondary" target="_blank" style="text-align: center; text-decoration: none; font-size: 12px;">
                                üì± iOS App
                            </a>
                            <a href="https://play.google.com/store/apps/details?id=io.element.android.x" class="btn btn-secondary" target="_blank" style="text-align: center; text-decoration: none; font-size: 12px;">
                                ü§ñ Android App
                            </a>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px;">
                            <p style="font-size: 12px; color: #d4d4d8; margin: 0;">
                                <strong>Note:</strong> QR login requires an already logged-in device. For your first login, enter credentials manually in the app.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="info-card success">
                    <div class="info-title">üí° Keep This Tab Open</div>
                    <div class="info-content">
                        You can switch between this tab and Element while logging in. Your credentials remain available above.
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="backToCredentials()" style="width: 100%; margin-top: 20px;">
                    ‚Üê Back to Credentials
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== State Management =====
        let currentMode = null; // 'standard' or 'assisted'
        let currentStep = 1;
        let selectedUsername = null;
        let generatedPassword = null;
        let passwordMode = 'manual';
        let createdUsername = null;
        let createdPassword = null;
        let credentialsWindow = null;

        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 768;
        }

        function tailorSuccessViewForDevice(isMobile) {
            updateCredentialReminder(isMobile);
            updateLoginHeading(isMobile);
            updateProceedButton(isMobile);
            updateLoginCardsContent(isMobile);
            prioritizeLoginInstructions(isMobile);
            toggleMobileCredentialActions(isMobile);
        }

        function updateCredentialReminder(isMobile) {
            const reminder = document.getElementById('credentialReminder');
            if (!reminder) return;

            if (isMobile) {
                reminder.innerHTML = 'Tap <strong>"Open Credentials in New Tab"</strong> before switching to Element X so you can return here and copy them while you sign in.';
            } else {
                reminder.innerHTML = 'Copy your credentials to a password manager before continuing. <strong>We opened a helper window</strong> to keep them handy while you switch tabs to log in.';
            }
        }

        function updateLoginHeading(isMobile) {
            const heading = document.getElementById('loginInstructionsHeading');
            if (!heading) return;
            heading.textContent = isMobile ? 'Step 2: Get the Element X Mobile App' : 'Step 2: Login to Your Account';
        }

        function updateProceedButton(isMobile) {
            const btn = document.getElementById('proceedToLoginBtn');
            if (!btn) return;
            btn.textContent = isMobile ? 'Show Mobile Login Steps ‚Üí' : "I've Saved My Credentials ‚Üí";
        }

        function updateLoginCardsContent(isMobile) {
            const webHeading = document.querySelector('#webInstructionsCard h4');
            const mobileHeading = document.querySelector('#mobileInstructionsCard h4');

            if (webHeading) {
                webHeading.textContent = isMobile ? 'üíª Sign in from a Computer (Optional)' : 'üåê Web Browser (Recommended)';
            }

            if (mobileHeading) {
                mobileHeading.textContent = isMobile ? 'üì± Mobile Setup (Start Here)' : 'üì± Mobile Setup';
            }
        }

        function prioritizeLoginInstructions(isMobile) {
            const mobileCard = document.getElementById('mobileInstructionsCard');
            const webCard = document.getElementById('webInstructionsCard');

            if (!mobileCard || !webCard) {
                return;
            }

            if (isMobile) {
                mobileCard.classList.add('mobile-priority', 'mobile-highlight');
                webCard.classList.remove('mobile-highlight');
            } else {
                mobileCard.classList.remove('mobile-priority', 'mobile-highlight');
            }
        }

        function toggleMobileCredentialActions(isMobile) {
            const container = document.getElementById('mobileCredentialActions');
            if (!container) {
                return;
            }

            container.style.display = isMobile ? 'block' : 'none';
        }

        // ===== Mode Selection =====
        function showModeSelection() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('modeSelectionView').classList.add('active');
            document.getElementById('modeIndicator').classList.remove('visible');
            document.getElementById('assistedProgress').classList.remove('visible');
            document.body.classList.remove('assisted-mode-active');
            currentMode = null;
            currentStep = 1;
        }

        function startStandardSetup() {
            currentMode = 'standard';
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('registrationView').classList.add('active');
            document.getElementById('modeIndicator').classList.add('visible');
            document.getElementById('modeIndicatorText').textContent = 'Standard Setup';
            document.getElementById('registerContainer').classList.remove('assisted-mode');
            document.body.classList.remove('assisted-mode-active');

            // Hide assisted mode elements
            document.getElementById('assistedProgress').classList.remove('visible');

            // Show all sections for standard mode
            document.querySelectorAll('.section').forEach(s => {
                s.style.display = 'block';
                s.classList.remove('highlight');
            });
            
            // Standard action buttons
            document.getElementById('actionButtons').className = 'action-buttons';
            document.getElementById('actionButtons').innerHTML = `
                <button class="btn btn-primary" id="createAccountBtn" onclick="createAccount()" disabled style="width: 100%;">
                    üöÄ Create Account
                </button>
            `;
            
            generateUsernames();
            updateCreateButton();
        }

        function startAssistedSetup() {
            currentMode = 'assisted';
            currentStep = 1;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('registrationView').classList.add('active');
            document.getElementById('modeIndicator').classList.add('visible');
            document.getElementById('modeIndicatorText').textContent = 'Assisted Setup';
            document.getElementById('registerContainer').classList.add('assisted-mode');
            document.body.classList.add('assisted-mode-active');

            // Show assisted mode elements
            document.getElementById('assistedProgress').classList.add('visible');

            // Hide all sections initially
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');

            // Show only first section
            showAssistedStep(1);

            // Assisted action buttons
            document.getElementById('actionButtons').className = 'action-buttons assisted';
            updateAssistedButtons();

            generateUsernames();
        }

        function showAssistedStep(step) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('highlight');
            });
            
            // Show current step section
            let section;
            switch(step) {
                case 1:
                    section = document.getElementById('usernameSection');
                    break;
                case 2:
                    section = document.getElementById('passwordSection');
                    break;
                case 3:
                    // Review step - show all sections as read-only
                    document.querySelectorAll('.section').forEach(s => {
                        s.style.display = 'block';
                        s.style.opacity = '0.7';
                        s.style.pointerEvents = 'none';
                    });
                    return;
            }

            if (section) {
                section.style.display = 'block';
                section.classList.add('highlight');
            }
        }

        function updateAssistedButtons() {
            const buttons = document.getElementById('actionButtons');
            
            if (currentStep === 3) {
                // Review step
                buttons.innerHTML = `
                    <button class="btn btn-secondary" onclick="previousAssistedStep()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="createAccount()" ${!isStepValid() ? 'disabled' : ''}>
                        üöÄ Create Account
                    </button>
                `;
            } else if (currentStep === 1) {
                buttons.innerHTML = `
                    <div></div>
                    <button class="btn btn-primary" onclick="nextAssistedStep()" ${!isStepValid() ? 'disabled' : ''}>
                        Continue ‚Üí
                    </button>
                `;
            } else {
                buttons.innerHTML = `
                    <button class="btn btn-secondary" onclick="previousAssistedStep()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextAssistedStep()" ${!isStepValid() ? 'disabled' : ''}>
                        Continue ‚Üí
                    </button>
                `;
            }
        }

        function isStepValid() {
            switch(currentStep) {
                case 1:
                    return selectedUsername !== null;
                case 2:
                    return generatedPassword !== null;
                case 3:
                    return selectedUsername && generatedPassword;
                default:
                    return false;
            }
        }

        function nextAssistedStep() {
            if (currentStep < 3 && isStepValid()) {
                // Update progress
                document.getElementById(`progress${currentStep}`).classList.remove('active');
                document.getElementById(`progress${currentStep}`).classList.add('completed');
                currentStep++;
                document.getElementById(`progress${currentStep}`).classList.add('active');
                
                // Show next step
                showAssistedStep(currentStep);
                updateAssistedButtons();
            }
        }

        function previousAssistedStep() {
            if (currentStep > 1) {
                // Enable interaction on sections again
                document.querySelectorAll('.section').forEach(s => {
                    s.style.opacity = '1';
                    s.style.pointerEvents = 'auto';
                });
                
                // Update progress
                document.getElementById(`progress${currentStep}`).classList.remove('active', 'completed');
                currentStep--;
                document.getElementById(`progress${currentStep}`).classList.remove('completed');
                document.getElementById(`progress${currentStep}`).classList.add('active');
                
                // Show previous step
                showAssistedStep(currentStep);
                updateAssistedButtons();
            }
        }

        // ===== Username Generation =====
        const usernameData = {
            adjectives: ["emergent", "symbiotic", "entangled", "recursive", "holistic", "adaptive", "resonant", "fluid", "networked", "crystalline", "quantum", "luminous"],
            nouns: ["mycelium", "network", "web", "node", "pattern", "wave", "flow", "spiral", "nexus", "matrix", "forest", "stream"]
        };

        function generateUsername() {
            const adj = usernameData.adjectives[Math.floor(Math.random() * usernameData.adjectives.length)];
            const noun = usernameData.nouns[Math.floor(Math.random() * usernameData.nouns.length)];
            const digits = Math.floor(Math.random() * 900000) + 100000;
            return `${adj}${noun}${digits}`;
        }

        function generateUsernames() {
            const grid = document.getElementById('usernameGrid');
            grid.innerHTML = '';
            selectedUsername = null;
            
            for (let i = 0; i < 4; i++) {
                const username = generateUsername();
                const card = document.createElement('div');
                card.className = 'username-card';
                card.innerHTML = `
                    <div class="username-text">${username}</div>
                    <div class="username-hint">@${username}:hyphae.social</div>
                `;
                card.onclick = () => selectUsername(card, username);
                grid.appendChild(card);
            }
            
            updateCreateButton();
            if (currentMode === 'assisted') {
                updateAssistedButtons();
            }
        }

        function selectUsername(card, username) {
            document.querySelectorAll('.username-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedUsername = username;
            updateCreateButton();
            if (currentMode === 'assisted') {
                updateAssistedButtons();
            }
        }

        // ===== Password Management =====
        function setPasswordMode(mode) {
            passwordMode = mode;
            document.getElementById('autoPasswordBtn').classList.toggle('active', mode === 'auto');
            document.getElementById('manualPasswordBtn').classList.toggle('active', mode === 'manual');
            document.getElementById('autoPasswordSection').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('manualPasswordSection').style.display = mode === 'manual' ? 'block' : 'none';
            
            if (mode === 'auto') {
                generatePassword();
            } else {
                document.getElementById('manualPassword').value = '';
                generatedPassword = null;
                updateCreateButton();
            }
        }

        function generatePassword() {
            const length = 16;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            
            generatedPassword = password;
            document.getElementById('passwordText').textContent = password;
            document.getElementById('copyBtn').style.display = 'inline-block';
            updateCreateButton();
            if (currentMode === 'assisted') {
                updateAssistedButtons();
            }
        }

        function handleManualPassword() {
            const password = document.getElementById('manualPassword').value;
            const indicator = document.getElementById('strengthIndicator');
            
            if (password.length === 0) {
                indicator.innerHTML = '';
                generatedPassword = null;
            } else if (password.length < 8) {
                indicator.innerHTML = '<span style="color: #ef4444;">‚ùå Too short (min 8 characters)</span>';
                generatedPassword = null;
            } else {
                let strength = 0;
                if (/[a-z]/.test(password)) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                if (strength < 3) {
                    indicator.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Add uppercase, numbers, symbols</span>';
                    generatedPassword = null;
                } else if (strength === 3) {
                    indicator.innerHTML = '<span style="color: #f59e0b;">‚úì Medium strength</span>';
                    generatedPassword = password;
                } else {
                    indicator.innerHTML = '<span style="color: #10b981;">‚úì Strong password!</span>';
                    generatedPassword = password;
                }
            }
            
            updateCreateButton();
            if (currentMode === 'assisted') {
                updateAssistedButtons();
            }
        }

        async function copyPassword() {
            const btn = document.getElementById('copyBtn');
            try {
                await navigator.clipboard.writeText(generatedPassword);
                btn.textContent = '‚úì Copied';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                showMessage('Failed to copy password', 'error');
            }
        }

        // ===== Account Creation =====
        function updateCreateButton() {
            if (currentMode === 'standard') {
                const btn = document.getElementById('createAccountBtn');
                if (btn) {
                    btn.disabled = !(selectedUsername && generatedPassword);
                }
            }
        }

        async function createAccount() {
            if (!selectedUsername || !generatedPassword) {
                showMessage('Please complete all required fields', 'error');
                return;
            }

            const btn = currentMode === 'assisted' ? 
                document.querySelector('.btn-primary:last-child') : 
                document.getElementById('createAccountBtn');
                
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Creating...';

            try {
                // Simulate account creation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // For demo purposes, we'll simulate success
                createdUsername = `@${selectedUsername}:hyphae.social`;
                createdPassword = generatedPassword;
                
                // Update success view
                document.getElementById('finalUsername').textContent = createdUsername;
                document.getElementById('finalPassword').dataset.password = createdPassword;
                document.getElementById('successUsernameDisplay').textContent = selectedUsername;
                
                // Generate QR code for mobile login
                generateLoginQR(createdUsername);
                
                // Show success view
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('successView').classList.add('active');
                document.getElementById('modeIndicator').classList.remove('visible');
                document.getElementById('assistedProgress').classList.remove('visible');

                if (currentMode === 'assisted') {
                    // Update final progress step
                    document.getElementById('progress3').classList.remove('active');
                    document.getElementById('progress3').classList.add('completed');
                    document.getElementById('progress4').classList.add('completed');
                }

                showMessage('Account created successfully!', 'success');

                const mobileDevice = isMobileDevice();
                tailorSuccessViewForDevice(mobileDevice);

                if (!mobileDevice) {
                    // Open a persistent credentials window
                    openCredentialsWindow();
                }

                // Note: In production, this would make an actual API call to create the account

            } catch (error) {
                console.error('Registration error:', error);
                btn.disabled = false;
                btn.innerHTML = currentMode === 'assisted' ? 'üöÄ Create Account' : 'üöÄ Create Account';
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        // Toggle password visibility in success view
        let passwordVisible = false;
        function togglePasswordView() {
            const passwordEl = document.getElementById('finalPassword');
            const btn = event.target;
            
            if (!passwordVisible) {
                passwordEl.textContent = passwordEl.dataset.password;
                btn.textContent = 'Hide';
                passwordVisible = true;
            } else {
                passwordEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                btn.textContent = 'Show';
                passwordVisible = false;
            }
        }

        // Proceed to login instructions
        function proceedToLogin() {
            document.getElementById('saveCredentialsStep').style.display = 'none';
            document.getElementById('loginInstructionsStep').style.display = 'block';
            
            // Smooth scroll to top of success view
            document.getElementById('successView').scrollIntoView({ behavior: 'smooth' });
        }

        // Back to credentials view
        function backToCredentials() {
            document.getElementById('loginInstructionsStep').style.display = 'none';
            document.getElementById('saveCredentialsStep').style.display = 'block';
        }

        // Open Element Web in new tab
        function openElementWeb() {
            // Open Element with the homeserver pre-configured if possible
            const elementUrl = 'https://app.element.io/#/login';
            const loginWindow = window.open(elementUrl, '_blank');
            
            // Show a helpful message
            showMessage('Element Web opened in a new tab. Enter "hyphae.social" as your homeserver.', 'success');
            
            // Keep credentials window visible
            if (credentialsWindow && !credentialsWindow.closed) {
                credentialsWindow.focus();
            }
        }

        // Generate QR code for mobile login
        let mainQRCode = null;
        let popupQRCode = null;
        
        function generateLoginQR(username) {
            const qrContainer = document.getElementById('qrCodeContainer');
            if (qrContainer && typeof QRCode !== 'undefined') {
                // Clear any existing QR code
                qrContainer.innerHTML = '';
                
                // Generate Matrix URI
                const matrixUri = `https://matrix.to/#/${username}`;
                
                // Create QR code
                mainQRCode = new QRCode(qrContainer, {
                    text: matrixUri,
                    width: 200,
                    height: 200,
                    colorDark: '#1a1d29',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
        
        // Download QR code as image
        async function downloadQR() {
            const canvas = document.querySelector('#qrCodeContainer canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `hyphae-${selectedUsername}-qr.png`;
                link.href = canvas.toDataURL();
                link.click();
                showMessage('QR code downloaded', 'success');
            }
        }
        
        // Share profile (using Web Share API if available)
        async function shareProfile() {
            const canvas = document.querySelector('#qrCodeContainer canvas');
            const matrixUri = `https://matrix.to/#/${createdUsername}`;
            
            if (navigator.share && canvas) {
                try {
                    // Try to share with image if possible
                    if (canvas.toBlob) {
                        const blob = await new Promise(resolve => canvas.toBlob(resolve));
                        if (blob) {
                            const file = new File([blob], 'hyphae-profile.png', { type: 'image/png' });
                            await navigator.share({
                                title: 'Add me on Hyphae Network',
                                text: `Add me on Matrix: ${createdUsername}\nScan this QR or use: ${matrixUri}`,
                                files: [file]
                            });
                            return;
                        }
                    }
                } catch (err) {
                    console.log('Image share failed, trying text only');
                }
                
                // Fallback to text-only share
                try {
                    await navigator.share({
                        title: 'Add me on Hyphae Network',
                        text: `Add me on Matrix: ${createdUsername}\nProfile link: ${matrixUri}`,
                        url: matrixUri
                    });
                } catch (err) {
                    copyMatrixUri();
                }
            } else {
                // Fallback to copying the URI
                copyMatrixUri();
            }
        }
        
        // Copy Matrix URI to clipboard
        async function copyMatrixUri() {
            const matrixUri = `https://matrix.to/#/${createdUsername}`;
            try {
                await navigator.clipboard.writeText(matrixUri);
                showMessage('Profile link copied to clipboard - share it to let others add you', 'success');
            } catch (err) {
                showMessage('Failed to copy profile link', 'error');
            }
        }

        // Open credentials window with QR code
        function openCredentialsWindow(forceNewTab = false) {
            const mobileDevice = isMobileDevice();

            if (mobileDevice && !forceNewTab) {
                return;
            }

            const matrixUri = `https://matrix.to/#/${createdUsername}`;

            let windowFeatures = '';
            let windowName = 'HyphaeCredentials';

            if (!mobileDevice) {
                const width = 450;
                const height = 650;
                const left = window.screen.width - width - 50;
                const top = 100;
                windowFeatures = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`;
            } else {
                windowName = 'HyphaeCredentialsMobile';
            }

            let popupRef = credentialsWindow;
            if (!popupRef || popupRef.closed || mobileDevice || forceNewTab) {
                popupRef = window.open('', windowName, windowFeatures);
            } else if (!mobileDevice) {
                popupRef.focus();
            }

            if (!popupRef) {
                const message = mobileDevice
                    ? 'Your browser blocked the credential tab. Allow popups or copy them from this page instead.'
                    : 'Please allow popups to keep your credentials visible while logging in.';
                showMessage(message, 'error');
                return;
            }

            credentialsWindow = popupRef;

            const credentialsHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Your Hyphae Credentials</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            background: #1a1d29;
                            color: #e0e0e0;
                            padding: 30px 20px;
                            margin: 0;
                        }
                        h2 {
                            color: #b4a5d8;
                            font-size: 24px;
                            margin-bottom: 20px;
                            text-align: center;
                        }
                        .warning {
                            background: rgba(239, 68, 68, 0.1);
                            border: 2px solid rgba(239, 68, 68, 0.3);
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                            font-size: 14px;
                        }
                        .credential {
                            margin-bottom: 20px;
                            background: #252836;
                            border: 1px solid #353849;
                            border-radius: 8px;
                            padding: 15px;
                        }
                        .label {
                            font-size: 12px;
                            color: #8a8a9e;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            margin-bottom: 8px;
                        }
                        .value {
                            font-family: 'Courier New', monospace;
                            font-size: 14px;
                            color: #b4a5d8;
                            word-break: break-all;
                        }
                        .copy-btn {
                            margin-top: 8px;
                            padding: 6px 12px;
                            background: rgba(180, 165, 216, 0.2);
                            border: none;
                            border-radius: 4px;
                            color: #b4a5d8;
                            font-size: 12px;
                            cursor: pointer;
                            width: 100%;
                        }
                        .copy-btn:hover {
                            background: rgba(180, 165, 216, 0.3);
                        }
                        .qr-section {
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            margin: 20px 0;
                            text-align: center;
                        }
                        #popupQR {
                            display: flex;
                            justify-content: center;
                            margin-bottom: 15px;
                        }
                        .qr-actions {
                            display: flex;
                            gap: 10px;
                            margin-top: 15px;
                        }
                        .qr-btn {
                            flex: 1;
                            padding: 8px;
                            background: #f0f0f0;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            color: #333;
                            font-size: 12px;
                            cursor: pointer;
                        }
                        .qr-btn:hover {
                            background: #e0e0e0;
                        }
                    </style>
                </head>
                <body>
                    <h2>üîê Your Credentials</h2>
                    <div class="warning">
                        <strong>‚ö†Ô∏è Keep this window open</strong><br>
                        Use these credentials to log in. Copy each field or scan the QR code with your mobile app.
                    </div>
                    <div class="credential">
                        <div class="label">Username</div>
                        <div class="value">${createdUsername}</div>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${createdUsername}').then(() => this.textContent = '‚úì Copied!', setTimeout(() => this.textContent = 'Copy Username', 2000))">Copy Username</button>
                    </div>
                    <div class="credential">
                        <div class="label">Password</div>
                        <div class="value">${createdPassword}</div>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${createdPassword}').then(() => this.textContent = '‚úì Copied!', setTimeout(() => this.textContent = 'Copy Password', 2000))">Copy Password</button>
                    </div>
                    <div class="credential">
                        <div class="label">Homeserver</div>
                        <div class="value">hyphae.social</div>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('hyphae.social').then(() => this.textContent = '‚úì Copied!', setTimeout(() => this.textContent = 'Copy Server', 2000))">Copy Server</button>
                    </div>
                    
                    <div class="qr-section">
                        <div style="color: #333; font-size: 14px; margin-bottom: 15px;">
                            <strong>Your Profile QR Code</strong><br>
                            <span style="font-size: 12px;">Others can scan this to add you as a contact</span>
                        </div>
                        <div id="popupQR"></div>
                        <div class="qr-actions">
                            <button class="qr-btn" onclick="downloadPopupQR()">üì• Save QR</button>
                            <button class="qr-btn" onclick="sharePopupProfile()">üì§ Share Profile</button>
                            <button class="qr-btn" onclick="copyURI()">üîó Copy Link</button>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                            <p style="font-size: 10px; color: #666; margin: 0; line-height: 1.4;">
                                <strong>For Mobile Login:</strong> Enter these credentials manually in Element X. QR login only works between already logged-in devices.
                            </p>
                        </div>
                    </div>
                    
                    <script>
                        // Generate QR code in popup
                        const qr = new QRCode(document.getElementById('popupQR'), {
                            text: '${matrixUri}',
                            width: 180,
                            height: 180,
                            colorDark: '#1a1d29',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        
                        function downloadPopupQR() {
                            const canvas = document.querySelector('#popupQR canvas');
                            if (canvas) {
                                const link = document.createElement('a');
                                link.download = 'hyphae-profile-qr.png';
                                link.href = canvas.toDataURL();
                                link.click();
                            }
                        }
                        
                        async function sharePopupProfile() {
                            const canvas = document.querySelector('#popupQR canvas');
                            if (navigator.share && canvas) {
                                try {
                                    const blob = await new Promise(resolve => canvas.toBlob(resolve));
                                    if (blob) {
                                        const file = new File([blob], 'hyphae-profile.png', { type: 'image/png' });
                                        await navigator.share({
                                            title: 'My Hyphae Network Profile',
                                            text: 'Add me on Matrix: ${createdUsername}',
                                            files: [file]
                                        });
                                    }
                                } catch(err) {
                                    copyURI();
                                }
                            } else {
                                copyURI();
                            }
                        }
                        
                        function copyURI() {
                            navigator.clipboard.writeText('${matrixUri}').then(() => {
                                const btn = event.target;
                                btn.textContent = '‚úì Copied!';
                                setTimeout(() => btn.textContent = 'üîó Copy Link', 2000);
                            });
                        }
                    <\/script>
                </body>
                </html>
            `;

            credentialsWindow.document.open();
            credentialsWindow.document.write(credentialsHTML);
            credentialsWindow.document.close();

            if (mobileDevice) {
                showMessage('Credentials opened in a new tab. Switch back here whenever you need to copy them again.', 'success');
            }
        }

        async function copyFinalCredential(type) {
            let text = '';
            const btn = event.target;
            
            if (type === 'username') {
                text = createdUsername;
            } else if (type === 'password') {
                text = document.getElementById('finalPassword').dataset.password;
            } else if (type === 'server') {
                text = 'hyphae.social';
            }
            
            try {
                await navigator.clipboard.writeText(text);
                btn.textContent = '‚úì Copied';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                showMessage('Failed to copy', 'error');
            }
        }

        // ===== Utilities =====
        function showMessage(text, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `message ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        window.addEventListener('resize', () => {
            const successView = document.getElementById('successView');
            if (!successView || !successView.classList.contains('active')) {
                return;
            }

            const mobileDevice = isMobileDevice();
            tailorSuccessViewForDevice(mobileDevice);

            if (!mobileDevice && createdUsername && (!credentialsWindow || credentialsWindow.closed)) {
                openCredentialsWindow();
            }
        });

        // ===== Initialize =====
        window.onload = () => {
            // Start with mode selection
            showModeSelection();
        };
    </script>
</body>
</html>
