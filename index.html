<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Room Notes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { background: white; border-radius: 12px; padding: 25px; max-width: 800px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h2 { color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 13px; margin-bottom: 15px; }
        .info { padding: 12px; margin-bottom: 15px; border-radius: 6px; font-size: 13px; background: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; }
        .error { background: #ffebee; border-left-color: #f44336; color: #c62828; }
        textarea { width: 100%; padding: 15px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; min-height: 350px; font-family: inherit; resize: vertical; }
        textarea:focus { outline: none; border-color: #667eea; }
        button { padding: 14px 24px; margin: 10px 10px 0 0; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 14px; font-weight: 600; cursor: pointer; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .help { font-size: 12px; color: #888; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="info" id="status">‚è≥ Connecting to Matrix...</div>
        <h2>üìù Room Notes</h2>
        <p class="subtitle">Private notes stored in your room account data</p>
        <textarea id="notes" placeholder="Type your notes here..."></textarea>
        <button onclick="saveNotes()" id="saveBtn" disabled>üíæ Save Notes</button>
        <button onclick="loadNotes()" id="loadBtn" disabled>üîÑ Reload</button>
        <p class="help">üí° Notes are stored privately in Matrix room account data and auto-load on open</p>
    </div>

    <script>
        const NOTE_KEY = 'social.hyphae.notes';
        let roomId = null;
        let requests = {};

        function log(msg) {
            console.log(`[${new Date().toLocaleTimeString()}]`, msg);
        }

        function updateStatus(msg, isError = false) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = isError ? 'info error' : 'info';
        }

        function sendToParent(action, data = {}) {
            const reqId = 'req_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            return new Promise((resolve, reject) => {
                requests[reqId] = { resolve, reject, action };
                
                log(`Sending: ${action}: ${JSON.stringify({
                    api: 'fromWidget',
                    widgetId: 'notes-widget',
                    requestId: reqId,
                    action,
                    data
                })}`);
                
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes-widget',
                    requestId: reqId,
                    action,
                    data
                }, '*');
                
                setTimeout(() => {
                    if (requests[reqId]) {
                        delete requests[reqId];
                        log(`Timeout for ${action}`);
                        reject(new Error(`Timeout waiting for ${action}`));
                    }
                }, 10000);
            });
        }

        window.addEventListener('message', (event) => {
            if (!event.data || event.data.api !== 'toWidget') return;
            
            log(`Received: ${JSON.stringify(event.data)}`);
            
            // Handle capabilities request
            if (event.data.action === 'capabilities') {
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes-widget',
                    requestId: event.data.requestId,
                    action: 'capabilities',
                    response: {
                        capabilities: [
                            'm.read_event_relations',
                            'org.matrix.msc2762.timeline:!AziSSuSIEjByDlOwxn:hyphae.social'
                        ]
                    }
                }, '*');
                return;
            }
            
            // Handle responses to our requests
            if (event.data.requestId && requests[event.data.requestId]) {
                const req = requests[event.data.requestId];
                delete requests[event.data.requestId];
                log(`Got response for: ${req.action}`);
                req.resolve(event.data.response || event.data);
            }
        });

        async function init() {
            try {
                log('Initializing widget: ' + window.location.search);
                
                // Try to get room ID from URL first
                const params = new URLSearchParams(window.location.search);
                roomId = params.get('roomId');
                
                if (!roomId) {
                    // Try to get it from OpenID
                    try {
                        const openIdData = await sendToParent('get_openid', {});
                        log(`Got OpenID: ${JSON.stringify(openIdData)}`);
                    } catch (e) {
                        log(`Could not get OpenID: ${JSON.stringify(e)}`);
                    }
                }
                
                if (!roomId) {
                    throw new Error('Could not determine room ID. Add ?roomId=!yourroom:domain to URL');
                }
                
                log(`Room ID: ${roomId}`);
                
                // Send ready signal
                await sendToParent('contentLoaded', {});
                
                updateStatus('‚úÖ Connected to Matrix room');
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('loadBtn').disabled = false;
                
                // Auto-load notes
                await loadNotes();
                
            } catch (error) {
                log(`Init error: ${JSON.stringify(error)}`);
                console.error('Initialization error:', error);
                updateStatus('‚ùå ' + error.message, true);
            }
        }

        async function saveNotes() {
            const text = document.getElementById('notes').value;
            updateStatus('‚è≥ Saving to Matrix...');
            
            try {
                // Save to room account data
                await sendToParent('send_event', {
                    type: 'm.room.account_data',
                    room_id: roomId,
                    state_key: NOTE_KEY,
                    content: {
                        notes: text,
                        updated: Date.now()
                    }
                });
                
                updateStatus('‚úÖ Saved to Matrix room!');
                log('Saved successfully');
            } catch (error) {
                console.error('Save error:', error);
                // Fallback to localStorage
                localStorage.setItem(NOTE_KEY + roomId, text);
                updateStatus('‚úÖ Saved locally (Matrix save pending)');
            }
        }

        async function loadNotes() {
            updateStatus('‚è≥ Loading from Matrix...');
            
            try {
                const response = await sendToParent('read_event', {
                    type: 'm.room.account_data',
                    room_id: roomId,
                    state_key: NOTE_KEY
                });
                
                if (response && response.content && response.content.notes) {
                    document.getElementById('notes').value = response.content.notes;
                    updateStatus('‚úÖ Loaded from Matrix');
                    log('Loaded from Matrix');
                } else {
                    throw new Error('No data found');
                }
            } catch (error) {
                // Fallback to localStorage
                const text = localStorage.getItem(NOTE_KEY + roomId) || '';
                document.getElementById('notes').value = text;
                updateStatus(text ? 'üìù Loaded from local storage' : 'üìù No saved notes');
                log('Loaded from localStorage');
            }
        }

        // Initialize
        window.addEventListener('load', init);
    </script>
</body>
</html>
